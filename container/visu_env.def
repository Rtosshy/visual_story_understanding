Bootstrap: docker
From: nvidia/cuda:12.9.1-base-ubuntu24.04

%post
    export DEBIAN_FRONTEND=noninteractive
    apt-get update
    apt-get install -y --no-install-recommends \
    curl \
    ca-certificates \
    git \
    build-essential \
    ninja-build

    # 明示的にコンパイラパスを確保
    which gcc
    which g++
    gcc --version
    g++ --version

    # シンボリック名を保証 (一部環境で cc / c++ を期待するツール向け)
    update-alternatives --install /usr/bin/cc cc /usr/bin/gcc 100
    update-alternatives --install /usr/bin/c++ c++ /usr/bin/g++ 100

    export CC=/usr/bin/gcc
    export CXX=/usr/bin/g++
    echo "CC=${CC}"  >> /etc/environment
    echo "CXX=${CXX}" >> /etc/environment

    echo "==> Installing uv..."
    curl -LsSf https://astral.sh/uv/install.sh | env UV_INSTALL_DIR="opt/bin" sh
    
    export PATH="/opt/bin:$PATH"

    uv --version

    PYTHON_VERSION="3.13.7"
    echo "==> Installing Python ${PYTHON_VERSION} with uv..."
    uv python install "${PYTHON_VERSION}"
    
    echo "==> Cleaning up build dependencies..."
    apt-get clean
    rm -rf /var/lib/apt/lists/*

%environment
    export PATH="/opt/bin:$PATH"

    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8

    export CC=/usr/bin/gcc
    export CXX=/usr/bin/g++
